---
alwaysApply: false
---

# Plan Phase - Level 4: Complex System

This document guides the planning phase for a Level 4 task. The L4 plan is a milestone list - a breakdown of the overall project into multiple independent sub-runs, each scoped as L1, L2, or L3. Every subsequent step in the L4 workflow is driven by this list. A bad milestone decomposition causes compounding problems across every sub-run; a good one makes the rest of the project mechanical.

## Step 1: Load Context

Read:
- `memory-bank/projectbrief.md`
- `memory-bank/tasks.md`
- `memory-bank/systemPatterns.md`
- `memory-bank/techContext.md`
- `memory-bank/activeContext.md`
- `.cursor/rules/shared/niko/memory-bank/milestones.mdc` (milestone format and quality criteria)

## Step 2: Verify Prerequisites

- Confirm `memory-bank/projectbrief.md` exists with the user story and requirements. If it's missing or too vague to decompose, ask the operator for clarification before continuing.
- Confirm `memory-bank/milestones.md` does **not** exist. If it does, a plan has already run for this task - re-entry routing applies. Stop and inform the operator which milestone is next.

## Step 3: Generate Milestone List

Decompose the overall task into an appropriate, optimal number of milestones. Apply the quality criteria from milestones.mdc (loaded in Step 1):

- Each milestone is independently deliverable as an L1/L2/L3 sub-run
- Each milestone is concrete enough that a future agent can classify it without additional context beyond the milestone + the memory bank files.
- Milestones cover the full project scope - no gaps, no overlap
- Sequence in dependency order: milestone N must not require work from milestone N+1
- If milestones have opportunities for parallelization
    - Add a flowchart at the top of the `memory-bank/milestones.md` file to show the dependency relationships between the milestones.
    - Create the milestone checklist in an order that is compatible with serial execution.

For each milestone, estimate its complexity level (L1/L2/L3) using the decision tree in `complexity-analysis.mdc`. This estimate is advisory - the actual classification happens at the start of each sub-run - but a milestone estimated as L4 is a signal it needs to be split further.

**If the task description is too vague to produce a confident milestone list**, stop here and ask the operator to clarify scope. Do not guess; a wrong decomposition cannot be fixed cheaply once sub-runs begin.

## Step 4: Write milestones.md

Write `memory-bank/milestones.md` following the format in milestones.mdc:

```markdown
# Milestones: <task-id>

[optional dependency flowchart to illustrate parallelization opportunities]

- [ ] <Milestone 1 description>
- [ ] <Milestone 2 description>
- [ ] <Milestone 3 description>
```

## Step 5: Update Memory Bank

Update `memory-bank/milestones.md`:
   - List each milestone with its estimated scope (L1/L2/L3) & a one-line rationale for the scope estimate.

Update `memory-bank/activeContext.md`:
   - Phase: `PLAN - COMPLETE`
   - What was done: milestone list generated (N milestones)
   - Next step: preflight to validate the milestone list

Update `memory-bank/progress.md` to record completion of the L4 plan phase.

## Step 6: Log Progress

Record the results by printing a summary in the following format:

~~~markdown
# L4 Plan Result

âœ… COMPLETE

## Milestones

- [ ] [Milestone 1 description] - estimated L[N]
- [ ] [Milestone 2 description] - estimated L[N]
- [ ] [Milestone 3 description] - estimated L[N]

## Next Steps

Preflight will now validate the milestone list.
~~~

## Step 7: Phase Transition

Invoke the `niko-preflight` skill to execute the preflight phase.
